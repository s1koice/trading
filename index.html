<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trading Journal</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background:#0b0f19; color:#e7eaf3; }
    header { padding: 18px 16px; border-bottom: 1px solid #1b2440; position: sticky; top:0; background:#0b0f19; z-index: 5; }
    h1 { margin: 0 0 6px; font-size: 18px; }
    .sub { color:#aab3d3; font-size: 13px; }

    main { max-width: 1150px; margin: 0 auto; padding: 16px; display: grid; gap: 16px; grid-template-columns: 380px 1fr; }
    .card { background:#0f1629; border:1px solid #1b2440; border-radius: 16px; padding: 14px; }
    .card h2 { margin: 0 0 10px; font-size: 14px; color:#cfd6f5; }
    .muted { color:#aab3d3; font-size: 12px; }

    label { display:block; font-size: 12px; color:#aab3d3; margin: 10px 0 6px; }
    input, select, textarea, button {
      width: 100%; box-sizing: border-box; border-radius: 12px; border: 1px solid #223057;
      background:#0b1020; color:#e7eaf3; padding: 10px 12px; font-size: 14px;
    }
    textarea { min-height: 88px; resize: vertical; }
    button { cursor:pointer; border: 1px solid #2d3d6f; background:#111a33; }
    button:hover { filter: brightness(1.05); }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .btnRow { display:flex; gap: 10px; }
    .btnRow button { width: auto; flex: 1; }

    .kpi { display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .kpi .box { background:#0b1020; border:1px solid #223057; border-radius: 14px; padding: 10px; }
    .kpi .v { font-size: 18px; margin-top: 4px; }

    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 14px; border:1px solid #1b2440; }
    th, td { padding: 10px; border-bottom:1px solid #1b2440; vertical-align: top; font-size: 13px; }
    th { text-align:left; color:#cfd6f5; background:#0b1020; position: sticky; top: 74px; z-index: 3; }
    tr:hover td { background:#0b1020; }
    .right { text-align:right; }

    .tag { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid #223057; font-size: 12px; color:#cfd6f5; }
    .pill { display:inline-flex; gap:8px; align-items:center; flex-wrap: wrap; }

    .divider { border:none; border-top:1px solid #1b2440; margin:14px 0; }

    .toast {
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: #0b1020; border:1px solid #223057; border-radius: 14px; padding: 10px 12px;
      min-width: 260px; max-width: 92vw; display:none; z-index: 9999;
    }
    .ok { color:#6ee7b7; }
    .warn { color:#fbbf24; }
    .bad { color:#fb7185; }

    /* Debug bar */
    .debugbar {
      position: fixed; top: 0; left: 0; right: 0; z-index: 9998;
      padding: 10px 12px; background:#0b1020; border-bottom:1px solid #223057;
      font: 14px system-ui; color:#e7eaf3;
    }
    .debugbox {
      margin-top: 10px; padding: 10px 12px; border-radius: 14px;
      background:#0b1020; border:1px solid #223057;
      max-height: 220px; overflow:auto; white-space: pre-wrap; word-break: break-word;
      font-size: 12px;
    }

    @media (max-width: 980px){
      main { grid-template-columns: 1fr; }
      th { top: 0; position: static; }
    }
  </style>

  <!-- ‚úÖ Supabase UMD (—á—Ç–æ–±—ã –±—ã–ª window.supabase) -->
  <script
    src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"
    onload="window.__SB_OK=true;"
    onerror="window.__SB_OK=false;alert('‚ùå –ù–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è Supabase JS (CDN). –û—Ç–∫–ª—é—á–∏ AdBlock/—Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –¥–∞–π –∑–Ω–∞—Ç—å ‚Äî —Å–¥–µ–ª–∞—é –≤–µ—Ä—Å–∏—é –±–µ–∑ CDN.');">
  </script>
</head>

<body>
<header>
  <h1>Trading Journal</h1>
  <div class="sub">–ñ—É—Ä–Ω–∞–ª —Å–¥–µ–ª–æ–∫ + –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (Supabase Postgres)</div>
</header>

<main>
  <section class="card">
    <h2>üîê –ê–∫–∫–∞—É–Ω—Ç</h2>

    <label>Email</label>
    <input id="email" placeholder="you@email.com" autocomplete="email" />

    <label>–ü–∞—Ä–æ–ª—å</label>
    <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />

    <div class="btnRow" style="margin-top:10px;">
      <button id="loginBtn" type="button">–í–æ–π—Ç–∏</button>
      <button id="signupBtn" type="button">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>

    <div class="btnRow" style="margin-top:10px;">
      <button id="logoutBtn" type="button">–í—ã–π—Ç–∏</button>
      <button id="reloadBtn" type="button">–û–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å–∏</button>
    </div>

    <div class="muted" id="authState" style="margin-top:10px;">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

    <hr class="divider">

    <h2>‚ûï –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h2>

    <div class="row">
      <div>
        <label>–î–∞—Ç–∞</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>–¢–∏–ø</label>
        <select id="type">
          <option value="trade">–°–¥–µ–ª–∫–∞</option>
          <option value="market">–ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞</option>
          <option value="review">–†–∞–∑–±–æ—Ä –¥–Ω—è</option>
        </select>
      </div>
    </div>

    <label>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä BTCUSDT / ES / AAPL)</label>
    <input id="symbol" placeholder="BTCUSDT" />

    <div class="row3">
      <div>
        <label>–°–µ—Ç–∞–ø / —Å—Ç—Ä–∞—Ç–µ–≥–∏—è</label>
        <input id="setup" placeholder="Breakout / Pullback / Range..." />
      </div>
      <div>
        <label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
        <select id="side">
          <option value="">‚Äî</option>
          <option value="long">Long</option>
          <option value="short">Short</option>
        </select>
      </div>
      <div>
        <label>–†–∏—Å–∫ (R)</label>
        <input id="risk" type="number" step="0.1" placeholder="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>–†–µ–∑—É–ª—å—Ç–∞—Ç (R)</label>
        <input id="resultR" type="number" step="0.1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 1.5 –∏–ª–∏ -1" />
      </div>
      <div>
        <label>–≠–º–æ—Ü–∏—è</label>
        <select id="emotion">
          <option value="">‚Äî</option>
          <option>—Å–ø–æ–∫–æ–π–Ω–æ</option>
          <option>—Å—Ç—Ä–∞—Ö</option>
          <option>–∂–∞–¥–Ω–æ—Å—Ç—å</option>
          <option>—Ñ–æ–º–æ</option>
          <option>–∑–ª–æ—Å—Ç—å</option>
          <option>—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</option>
        </select>
      </div>
    </div>

    <label>–ü–ª–∞–Ω / –∫–æ–Ω—Ç–µ–∫—Å—Ç (—á—Ç–æ –≤–∏–¥–µ–ª –Ω–∞ —Ä—ã–Ω–∫–µ)</label>
    <textarea id="context" placeholder="–¢—Ä–µ–Ω–¥, —É—Ä–æ–≤–Ω–∏, –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å, –Ω–æ–≤–æ—Å—Ç–∏, —á—Ç–æ –æ–∂–∏–¥–∞–ª..."></textarea>

    <label>–ò—Ç–æ–≥ / –æ—à–∏–±–∫–∏ / —á—Ç–æ —É–ª—É—á—à–∏—Ç—å</label>
    <textarea id="lessons" placeholder="–ß—Ç–æ —Å–¥–µ–ª–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –≥–¥–µ –Ω–∞—Ä—É—à–∏–ª –ø—Ä–∞–≤–∏–ª–∞, –ø–ª–∞–Ω —É–ª—É—á—à–µ–Ω–∏—è..."></textarea>

    <div class="btnRow" style="margin-top:10px;">
      <button id="saveBtn" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î</button>
      <button id="resetBtn" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <p class="muted" style="margin-top:10px;">
      ‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ <b>–≤–æ–π—Ç–∏</b> –∏–ª–∏ <b>–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</b>. –ò–Ω–∞—á–µ –∑–∞–ø–∏—Å—å –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è.
    </p>

    <div class="debugbox" id="debugLog"></div>
  </section>

  <section class="card">
    <h2>üìä –î–∞—à–±–æ—Ä–¥</h2>
    <div class="kpi" id="kpi"></div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label>–ü–æ–∏—Å–∫</label>
        <input id="q" placeholder="BTC / breakout / –æ—à–∏–±–∫–∏..." />
      </div>
      <div>
        <label>–§–∏–ª—å—Ç—Ä —Ç–∏–ø–∞</label>
        <select id="filterType">
          <option value="">–í—Å–µ</option>
          <option value="trade">–°–¥–µ–ª–∫–∞</option>
          <option value="market">–ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞</option>
          <option value="review">–†–∞–∑–±–æ—Ä –¥–Ω—è</option>
        </select>
      </div>
    </div>

    <div class="muted" id="listState" style="margin-top:10px;">‚Äî</div>

    <div style="margin-top:12px; overflow:auto;">
      <table>
        <thead>
          <tr>
            <th style="width:110px;">–î–∞—Ç–∞</th>
            <th style="width:110px;">–¢–∏–ø</th>
            <th>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</th>
            <th style="width:100px;" class="right">R</th>
            <th style="width:140px;">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </section>
</main>

<div class="toast" id="toast"></div>

<script>
  // =========================
  // CONFIG (—Ç–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ)
  // =========================
  const SUPABASE_URL = "https://lchstbkuizgablzdczgf.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjaHN0Ymt1aXpnYWJsemRjemdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NzE2MDQsImV4cCI6MjA4MjM0NzYwNH0.0HnmhHZSDNktliI1ieg7F_ehVuvDp3nwh8vhFJM6eRg";

  // =========================
  // HELPERS
  // =========================
  const $ = (id) => document.getElementById(id);

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function log(msg){
    const box = $("debugLog");
    const t = new Date().toLocaleTimeString();
    box.textContent = `[${t}] ${msg}\n` + box.textContent;
  }

  function toast(msg, kind="ok"){
    const el = $("toast");
    el.style.display = "block";
    el.innerHTML = `<span class="${kind}">${escapeHtml(msg)}</span>`;
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> el.style.display="none", 2800);
  }

  function todayISO(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60*1000);
    return local.toISOString().slice(0,10);
  }

  function numOrNull(v){
    if (v === "" || v == null) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function formatType(t){
    return t === "trade" ? "–°–¥–µ–ª–∫–∞" : t === "market" ? "–ê–Ω–∞–ª–∏–∑" : "–†–∞–∑–±–æ—Ä";
  }

  function setFormEnabled(enabled){
    const ids = ["date","type","symbol","setup","side","risk","resultR","emotion","context","lessons","saveBtn","resetBtn"];
    ids.forEach(id => $(id).disabled = !enabled);
  }

  // =========================
  // DEBUG BAR (–≤–∏–¥–Ω–æ –≤—Å–µ–≥–¥–∞)
  // =========================
  function addDebugBar(){
    const bar = document.createElement("div");
    bar.className = "debugbar";
    const sb = window.__SB_OK ? "OK" : "–ù–ï –ó–ê–ì–†–£–ñ–ï–ù";
    bar.innerHTML = `‚úÖ JS —Ä–∞–±–æ—Ç–∞–µ—Ç. Supabase: <b>${sb}</b> ¬∑ <span class="muted">–ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–µ —Ä–µ–∞–≥–∏—Ä—É—é—Ç ‚Äî –∑–Ω–∞—á–∏—Ç JS –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–ª–∏ —Ñ–∞–π–ª –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è.</span>`;
    document.body.appendChild(bar);
    document.body.style.paddingTop = "44px";
  }

  // =========================
  // SUPABASE INIT
  // =========================
  const SB = window.supabase;
  let supabase = null;
  if (SB && SB.createClient) {
    supabase = SB.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }

  // =========================
  // STATE
  // =========================
  const state = { entries: [], filterType: "", q: "" };
  let currentUser = null;

  // =========================
  // AUTH
  // =========================
  async function refreshAuth(){
    if(!supabase){
      $("authState").innerHTML = `‚ùå <span class="bad">Supabase JS –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.</span>`;
      setFormEnabled(false);
      $("logoutBtn").disabled = true;
      log("Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (supabase == null).");
      return;
    }

    try {
      const { data, error } = await supabase.auth.getUser();
      if (error) throw error;
      currentUser = data.user || null;

      if(currentUser){
        $("authState").innerHTML = `‚úÖ <span class="ok">–í—Ö–æ–¥:</span> ${escapeHtml(currentUser.email)}`;
        $("logoutBtn").disabled = false;
        setFormEnabled(true);
        log("Auth OK: user=" + currentUser.email);
      } else {
        $("authState").innerHTML = `‚ö†Ô∏è <span class="warn">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.</span> –í–æ–π–¥–∏ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è.`;
        $("logoutBtn").disabled = true;
        setFormEnabled(false);
        log("Auth: user=null");
      }
    } catch(e){
      $("authState").innerHTML = `‚ùå <span class="bad">Auth –æ—à–∏–±–∫–∞:</span> ${escapeHtml(e.message || e)}`;
      $("logoutBtn").disabled = true;
      setFormEnabled(false);
      log("Auth error: " + (e.message || e));
    }
  }

  async function login(){
    toast("–ö–ª–∏–∫: –í–æ–π—Ç–∏", "warn");
    log("–ù–∞–∂–∞–ª–∏ –í–æ–π—Ç–∏.");

    if(!supabase){
      alert("Supabase –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (CDN/AdBlock).");
      return;
    }

    const email = $("email").value.trim();
    const password = $("password").value;
    if(!email || !password){
      toast("–ó–∞–ø–æ–ª–Ω–∏ email –∏ –ø–∞—Ä–æ–ª—å", "warn");
      log("–ü—É—Å—Ç–æ–π email/–ø–∞—Ä–æ–ª—å.");
      return;
    }

    $("loginBtn").disabled = true;
    try{
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) throw error;

      toast("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω", "ok");
      log("–í—Ö–æ–¥ OK.");
      await refreshAuth();
      await loadFromDB();
    } catch(e){
      toast(e.message || "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞", "bad");
      log("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + (e.message || e));
    } finally {
      $("loginBtn").disabled = false;
    }
  }

  async function signup(){
    toast("–ö–ª–∏–∫: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", "warn");
    log("–ù–∞–∂–∞–ª–∏ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è.");

    if(!supabase){
      alert("Supabase –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (CDN/AdBlock).");
      return;
    }

    const email = $("email").value.trim();
    const password = $("password").value;
    if(!email || !password){
      toast("–ó–∞–ø–æ–ª–Ω–∏ email –∏ –ø–∞—Ä–æ–ª—å", "warn");
      log("–ü—É—Å—Ç–æ–π email/–ø–∞—Ä–æ–ª—å.");
      return;
    }

    $("signupBtn").disabled = true;
    try{
      const { data, error } = await supabase.auth.signUp({ email, password });
      if(error) throw error;

      toast("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞. –ï—Å–ª–∏ –Ω–∞–¥–æ ‚Äî –ø—Ä–æ–≤–µ—Ä—å –ø–æ—á—Ç—É.", "ok");
      log("Signup OK. user=" + (data?.user?.email || "null (–º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)"));

      await refreshAuth();
      await loadFromDB();
    } catch(e){
      toast(e.message || "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏", "bad");
      log("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + (e.message || e));
    } finally {
      $("signupBtn").disabled = false;
    }
  }

  async function logout(){
    toast("–ö–ª–∏–∫: –í—ã–π—Ç–∏", "warn");
    log("–ù–∞–∂–∞–ª–∏ –í—ã–π—Ç–∏.");

    if(!supabase) return;
    try{
      await supabase.auth.signOut();
      state.entries = [];
      render();
      await refreshAuth();
      toast("–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω", "ok");
      log("–í—ã—Ö–æ–¥ OK.");
    } catch(e){
      toast(e.message || "–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞", "bad");
      log("–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: " + (e.message || e));
    }
  }

  // =========================
  // DB
  // =========================
  function mapFromDB(x){
    return {
      id: x.id,
      date: x.date,
      type: x.type,
      symbol: x.symbol || "",
      setup: x.setup || "",
      side: x.side || "",
      risk: x.risk,
      resultR: x.result_r,
      emotion: x.emotion || "",
      context: x.context || "",
      lessons: x.lessons || "",
      createdAt: x.created_at
    };
  }

  async function loadFromDB(){
    if(!currentUser){
      $("listState").textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö: –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏.";
      state.entries = [];
      render();
      log("loadFromDB: user=null");
      return;
    }

    $("listState").textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
    log("loadFromDB: start");

    const { data, error } = await supabase
      .from("entries")
      .select("*")
      .order("date", { ascending: false })
      .order("created_at", { ascending: false });

    if(error){
      $("listState").innerHTML = `<span class="bad">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:</span> ${escapeHtml(error.message)}`;
      state.entries = [];
      render();
      log("loadFromDB error: " + error.message);
      return;
    }

    state.entries = (data || []).map(mapFromDB);
    $("listState").textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${state.entries.length}`;
    log("loadFromDB OK: " + state.entries.length);
    render();
  }

  async function insertToDB(entry){
    if(!currentUser){
      toast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏", "warn");
      log("insertToDB: user=null");
      return false;
    }

    const payload = {
      user_id: currentUser.id,
      date: entry.date,
      type: entry.type,
      symbol: entry.symbol || null,
      setup: entry.setup || null,
      side: entry.side || null,
      risk: entry.risk,
      result_r: entry.resultR,
      emotion: entry.emotion || null,
      context: entry.context || null,
      lessons: entry.lessons || null
    };

    const { error } = await supabase.from("entries").insert(payload);
    if(error){
      toast("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + error.message, "bad");
      log("insertToDB error: " + error.message);
      return false;
    }
    log("insertToDB OK");
    return true;
  }

  async function deleteFromDB(id){
    const { error } = await supabase.from("entries").delete().eq("id", id);
    if(error){
      toast("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + error.message, "bad");
      log("deleteFromDB error: " + error.message);
      return false;
    }
    log("deleteFromDB OK");
    return true;
  }

  // =========================
  // UI
  // =========================
  function resetForm(){
    $("date").value = todayISO();
    $("type").value = "trade";
    $("symbol").value = "";
    $("setup").value = "";
    $("side").value = "";
    $("risk").value = "";
    $("resultR").value = "";
    $("emotion").value = "";
    $("context").value = "";
    $("lessons").value = "";
  }

  function filtered(){
    const q = state.q.trim().toLowerCase();
    return state.entries.filter(e => {
      const okType = !state.filterType || e.type === state.filterType;
      const hay = [e.symbol, e.setup, e.side, e.emotion, e.context, e.lessons, e.type, e.date].join(" ").toLowerCase();
      const okQ = !q || hay.includes(q);
      return okType && okQ;
    });
  }

  function render(){
    const trades = state.entries.filter(e => e.type === "trade");
    const totalR = trades.reduce((s,e)=> s + (Number(e.resultR) || 0), 0);
    const wins = trades.filter(e => (Number(e.resultR) || 0) > 0).length;
    const winrate = trades.length ? Math.round((wins / trades.length) * 100) : 0;

    const kpi = [
      {k:"–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π", v: state.entries.length},
      {k:"–°–¥–µ–ª–æ–∫", v: trades.length},
      {k:"Winrate", v: winrate + "%"},
      {k:"–°—É–º–º–∞—Ä–Ω–æ R", v: (Math.round(totalR*10)/10).toString()}
    ];
    $("kpi").innerHTML = kpi.map(x => `
      <div class="box">
        <div class="muted">${escapeHtml(x.k)}</div>
        <div class="v">${escapeHtml(x.v)}</div>
      </div>
    `).join("");

    const rows = filtered();
    $("rows").innerHTML = rows.map(e => `
      <tr>
        <td>${escapeHtml(e.date || "")}</td>
        <td><span class="tag">${escapeHtml(formatType(e.type))}</span></td>
        <td>
          <div class="pill">
            <strong>${escapeHtml(e.symbol || "‚Äî")}</strong>
            ${e.side ? `<span class="tag">${escapeHtml(e.side.toUpperCase())}</span>` : ""}
            ${e.setup ? `<span class="tag">${escapeHtml(e.setup)}</span>` : ""}
            ${e.emotion ? `<span class="tag">${escapeHtml(e.emotion)}</span>` : ""}
          </div>
          <div class="muted" style="margin-top:6px;">
            ${escapeHtml((e.context || e.lessons || "").slice(0, 220))}${(e.context||e.lessons||"").length>220?"‚Ä¶":""}
          </div>
        </td>
        <td class="right">${e.type==="trade" ? escapeHtml(e.resultR ?? "‚Äî") : "‚Äî"}</td>
        <td><button onclick="window.__del('${e.id}')">–£–¥–∞–ª–∏—Ç—å</button></td>
      </tr>
    `).join("");

    if(currentUser){
      $("listState").textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ: ${rows.length} (–≤—Å–µ–≥–æ: ${state.entries.length})`;
    }
  }

  async function addEntry(){
    toast("–ö–ª–∏–∫: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "warn");
    log("–ù–∞–∂–∞–ª–∏ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å.");

    const entry = {
      date: $("date").value || todayISO(),
      type: $("type").value,
      symbol: $("symbol").value.trim(),
      setup: $("setup").value.trim(),
      side: $("side").value,
      risk: numOrNull($("risk").value),
      resultR: numOrNull($("resultR").value),
      emotion: $("emotion").value,
      context: $("context").value.trim(),
      lessons: $("lessons").value.trim()
    };

    if(entry.type === "trade" && !entry.symbol){
      toast("–î–ª—è —Å–¥–µ–ª–∫–∏ —É–∫–∞–∂–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "warn");
      log("–í–∞–ª–∏–¥–∞—Ü–∏—è: –ø—É—Å—Ç–æ–π symbol.");
      return;
    }

    $("saveBtn").disabled = true;
    const ok = await insertToDB(entry);
    $("saveBtn").disabled = false;

    if(ok){
      resetForm();
      await loadFromDB();
      toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ë–î", "ok");
    }
  }

  async function del(id){
    if(!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) return;
    await deleteFromDB(id);
    await loadFromDB();
  }
  window.__del = del;

  // =========================
  // INIT
  // =========================
  document.addEventListener("DOMContentLoaded", async () => {
    addDebugBar();
    $("date").value = todayISO();
    setFormEnabled(false);
    $("logoutBtn").disabled = true;
    log("DOMContentLoaded: JS –∑–∞–ø—É—Å—Ç–∏–ª—Å—è.");

    // –í–ê–ñ–ù–û: —ç—Ç–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –¥–∞—Ç—å —Ä–µ–∞–∫—Ü–∏—é –≤—Å–µ–≥–¥–∞
    $("loginBtn").addEventListener("click", login);
    $("signupBtn").addEventListener("click", signup);
    $("logoutBtn").addEventListener("click", logout);
    $("reloadBtn").addEventListener("click", () => { toast("–ö–ª–∏–∫: –û–±–Ω–æ–≤–∏—Ç—å", "warn"); loadFromDB(); });
    $("saveBtn").addEventListener("click", addEntry);
    $("resetBtn").addEventListener("click", () => { toast("–§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞", "ok"); resetForm(); });

    $("q").addEventListener("input", (e)=>{ state.q = e.target.value; render(); });
    $("filterType").addEventListener("change", (e)=>{ state.filterType = e.target.value; render(); });

    // –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ supabase
    if(!supabase){
      $("authState").innerHTML = `‚ùå <span class="bad">Supabase JS –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.</span> –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è CDN.`;
      log("supabase == null (CDN blocked?)");
      return;
    }

    await refreshAuth();
    await loadFromDB();
    render();
  });
</script>

</body>
</html>
