<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trading Journal</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background:#0b0f19; color:#e7eaf3; }
    header { padding: 20px 16px; border-bottom: 1px solid #1b2440; position: sticky; top:0; background:#0b0f19; }
    h1 { margin: 0 0 6px; font-size: 18px; }
    .sub { color:#aab3d3; font-size: 13px; }
    main { max-width: 1100px; margin: 0 auto; padding: 16px; display: grid; gap: 16px; grid-template-columns: 360px 1fr; }
    .card { background:#0f1629; border:1px solid #1b2440; border-radius: 16px; padding: 14px; }
    .card h2 { margin: 0 0 10px; font-size: 14px; color:#cfd6f5; }
    label { display:block; font-size: 12px; color:#aab3d3; margin: 10px 0 6px; }
    input, select, textarea, button {
      width: 100%; box-sizing: border-box; border-radius: 12px; border: 1px solid #223057;
      background:#0b1020; color:#e7eaf3; padding: 10px 12px; font-size: 14px;
    }
    textarea { min-height: 88px; resize: vertical; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    button { cursor:pointer; border: 1px solid #2d3d6f; background:#111a33; }
    button:hover { filter: brightness(1.05); }
    .btnRow { display:flex; gap: 10px; }
    .btnRow button { width: auto; flex: 1; }
    .kpi { display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .kpi .box { background:#0b1020; border:1px solid #223057; border-radius: 14px; padding: 10px; }
    .kpi .v { font-size: 18px; margin-top: 4px; }
    .muted { color:#aab3d3; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 14px; border:1px solid #1b2440; }
    th, td { padding: 10px; border-bottom:1px solid #1b2440; vertical-align: top; font-size: 13px; }
    th { text-align:left; color:#cfd6f5; background:#0b1020; position: sticky; top: 74px; }
    tr:hover td { background:#0b1020; }
    .tag { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid #223057; font-size: 12px; color:#cfd6f5; }
    .pill { display:inline-flex; gap:8px; align-items:center; }
    .right { text-align:right; }
    @media (max-width: 980px){
      main { grid-template-columns: 1fr; }
      th { top: 0; position: static; }
    }
  </style>
</head>
<body>
<header>
  <h1>Trading Journal</h1>
  <div class="sub">–ñ—É—Ä–Ω–∞–ª —Å–¥–µ–ª–æ–∫ + –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ (–ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ, —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç)</div>
</header>

<main>
  <section class="card">
    <h2>‚ûï –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h2>

    <div class="row">
      <div>
        <label>–î–∞—Ç–∞</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>–¢–∏–ø</label>
        <select id="type">
          <option value="trade">–°–¥–µ–ª–∫–∞</option>
          <option value="market">–ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞</option>
          <option value="review">–†–∞–∑–±–æ—Ä –¥–Ω—è</option>
        </select>
      </div>
    </div>

    <label>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä BTCUSDT / ES / AAPL)</label>
    <input id="symbol" placeholder="BTCUSDT" />

    <div class="row3">
      <div>
        <label>–°–µ—Ç–∞–ø / —Å—Ç—Ä–∞—Ç–µ–≥–∏—è</label>
        <input id="setup" placeholder="Breakout / Pullback / Range..." />
      </div>
      <div>
        <label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
        <select id="side">
          <option value="">‚Äî</option>
          <option value="long">Long</option>
          <option value="short">Short</option>
        </select>
      </div>
      <div>
        <label>–†–∏—Å–∫ (R)</label>
        <input id="risk" type="number" step="0.1" placeholder="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>–†–µ–∑—É–ª—å—Ç–∞—Ç (R)</label>
        <input id="resultR" type="number" step="0.1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 1.5 –∏–ª–∏ -1" />
      </div>
      <div>
        <label>–≠–º–æ—Ü–∏—è</label>
        <select id="emotion">
          <option value="">‚Äî</option>
          <option>—Å–ø–æ–∫–æ–π–Ω–æ</option>
          <option>—Å—Ç—Ä–∞—Ö</option>
          <option>–∂–∞–¥–Ω–æ—Å—Ç—å</option>
          <option>—Ñ–æ–º–æ</option>
          <option>–∑–ª–æ—Å—Ç—å</option>
          <option>—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</option>
        </select>
      </div>
    </div>

    <label>–ü–ª–∞–Ω / –∫–æ–Ω—Ç–µ–∫—Å—Ç (—á—Ç–æ –≤–∏–¥–µ–ª –Ω–∞ —Ä—ã–Ω–∫–µ)</label>
    <textarea id="context" placeholder="–¢—Ä–µ–Ω–¥, —É—Ä–æ–≤–Ω–∏, –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å, –Ω–æ–≤–æ—Å—Ç–∏, —á—Ç–æ –æ–∂–∏–¥–∞–ª..."></textarea>

    <label>–ò—Ç–æ–≥ / –æ—à–∏–±–∫–∏ / —á—Ç–æ —É–ª—É—á—à–∏—Ç—å</label>
    <textarea id="lessons" placeholder="–ß—Ç–æ —Å–¥–µ–ª–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –≥–¥–µ –Ω–∞—Ä—É—à–∏–ª –ø—Ä–∞–≤–∏–ª–∞, –ø–ª–∞–Ω —É–ª—É—á—à–µ–Ω–∏—è..."></textarea>

    <div class="btnRow" style="margin-top:10px;">
      <button id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="reset" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <hr style="border:none;border-top:1px solid #1b2440;margin:14px 0;">

    <h2>üì¶ –≠–∫—Å–ø–æ—Ä—Ç / –∏–º–ø–æ—Ä—Ç</h2>
    <div class="btnRow">
      <button id="export">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      <button id="importBtn" type="button">–ò–º–ø–æ—Ä—Ç JSON</button>
    </div>
    <input id="importFile" type="file" accept="application/json" style="display:none;" />

    <p class="muted" style="margin-top:10px;">
      ‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (LocalStorage). –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π JSON —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é ‚Äî –∏ —Ç—ã –Ω–µ –ø–æ—Ç–µ—Ä—è–µ—à—å –∂—É—Ä–Ω–∞–ª.
    </p>
  </section>

  <section class="card">
    <h2>üìä –î–∞—à–±–æ—Ä–¥</h2>
    <div class="kpi" id="kpi"></div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label>–ü–æ–∏—Å–∫</label>
        <input id="q" placeholder="BTC / breakout / –æ—à–∏–±–∫–∏..." />
      </div>
      <div>
        <label>–§–∏–ª—å—Ç—Ä —Ç–∏–ø–∞</label>
        <select id="filterType">
          <option value="">–í—Å–µ</option>
          <option value="trade">–°–¥–µ–ª–∫–∞</option>
          <option value="market">–ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞</option>
          <option value="review">–†–∞–∑–±–æ—Ä –¥–Ω—è</option>
        </select>
      </div>
    </div>

    <div style="margin-top:12px; overflow:auto;">
      <table>
        <thead>
          <tr>
            <th style="width:110px;">–î–∞—Ç–∞</th>
            <th style="width:110px;">–¢–∏–ø</th>
            <th>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</th>
            <th style="width:100px;" class="right">R</th>
            <th style="width:140px;">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
  const LS_KEY = "trading_journal_v1";

  const $ = (id) => document.getElementById(id);

  const state = {
    entries: load(),
    filterType: "",
    q: ""
  };

  function todayISO(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60*1000);
    return local.toISOString().slice(0,10);
  }

  function load(){
    try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
    catch { return []; }
  }

  function saveAll(){
    localStorage.setItem(LS_KEY, JSON.stringify(state.entries));
    render();
  }

  function uid(){
    return Math.random().toString(36).slice(2) + Date.now().toString(36);
  }

  function formatType(t){
    return t === "trade" ? "–°–¥–µ–ª–∫–∞" : t === "market" ? "–ê–Ω–∞–ª–∏–∑" : "–†–∞–∑–±–æ—Ä";
  }

  function addEntry(){
    const entry = {
      id: uid(),
      date: $("date").value || todayISO(),
      type: $("type").value,
      symbol: $("symbol").value.trim(),
      setup: $("setup").value.trim(),
      side: $("side").value,
      risk: numOrNull($("risk").value),
      resultR: numOrNull($("resultR").value),
      emotion: $("emotion").value,
      context: $("context").value.trim(),
      lessons: $("lessons").value.trim(),
      createdAt: new Date().toISOString()
    };
    state.entries.unshift(entry);
    saveAll();
    resetForm();
  }

  function numOrNull(v){
    if (v === "" || v == null) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function resetForm(){
    $("date").value = todayISO();
    $("type").value = "trade";
    $("symbol").value = "";
    $("setup").value = "";
    $("side").value = "";
    $("risk").value = "";
    $("resultR").value = "";
    $("emotion").value = "";
    $("context").value = "";
    $("lessons").value = "";
  }

  function del(id){
    state.entries = state.entries.filter(e => e.id !== id);
    saveAll();
  }

  function exportJSON(){
    const blob = new Blob([JSON.stringify(state.entries, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `trading-journal-${todayISO()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function importJSON(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(reader.result);
        if(!Array.isArray(data)) throw new Error("Not array");
        // merge by id
        const map = new Map(state.entries.map(e => [e.id, e]));
        data.forEach(e => {
          if (e && e.id) map.set(e.id, e);
        });
        state.entries = Array.from(map.values()).sort((a,b)=> (b.date||"").localeCompare(a.date||""));
        saveAll();
      }catch(err){
        alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ JSON. –ü—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª.");
      }
    };
    reader.readAsText(file);
  }

  function filtered(){
    const q = state.q.toLowerCase();
    return state.entries.filter(e => {
      const okType = !state.filterType || e.type === state.filterType;
      const hay = [
        e.symbol, e.setup, e.side, e.emotion, e.context, e.lessons, e.type, e.date
      ].join(" ").toLowerCase();
      const okQ = !q || hay.includes(q);
      return okType && okQ;
    });
  }

  function render(){
    // KPI
    const trades = state.entries.filter(e => e.type === "trade");
    const totalR = trades.reduce((s,e)=> s + (e.resultR || 0), 0);
    const wins = trades.filter(e => (e.resultR || 0) > 0).length;
    const losses = trades.filter(e => (e.resultR || 0) < 0).length;
    const winrate = trades.length ? Math.round((wins / trades.length) * 100) : 0;

    const kpi = [
      {k:"–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π", v: state.entries.length},
      {k:"–°–¥–µ–ª–æ–∫", v: trades.length},
      {k:"Winrate", v: winrate + "%"},
      {k:"–°—É–º–º–∞—Ä–Ω–æ R", v: (Math.round(totalR*10)/10).toString()}
    ];

    $("kpi").innerHTML = kpi.map(x => `
      <div class="box">
        <div class="muted">${x.k}</div>
        <div class="v">${x.v}</div>
      </div>
    `).join("");

    // rows
    const rows = filtered();
    $("rows").innerHTML = rows.map(e => `
      <tr>
        <td>${e.date || ""}</td>
        <td><span class="tag">${formatType(e.type)}</span></td>
        <td>
          <div class="pill">
            <strong>${escapeHtml(e.symbol || "‚Äî")}</strong>
            ${e.side ? `<span class="tag">${e.side.toUpperCase()}</span>` : ""}
            ${e.setup ? `<span class="tag">${escapeHtml(e.setup)}</span>` : ""}
          </div>
          <div class="muted" style="margin-top:6px;">
            ${escapeHtml((e.context || e.lessons || "").slice(0, 180))}${(e.context||e.lessons||"").length>180?"‚Ä¶":""}
          </div>
        </td>
        <td class="right">${e.type==="trade" ? (e.resultR ?? "‚Äî") : "‚Äî"}</td>
        <td>
          <button onclick="window.__del('${e.id}')">–£–¥–∞–ª–∏—Ç—å</button>
        </td>
      </tr>
    `).join("");
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  window.__del = del;

  // init
  $("date").value = todayISO();
  $("save").addEventListener("click", addEntry);
  $("reset").addEventListener("click", resetForm);
  $("export").addEventListener("click", exportJSON);
  $("importBtn").addEventListener("click", () => $("importFile").click());
  $("importFile").addEventListener("change", (e) => {
    if (e.target.files && e.target.files[0]) importJSON(e.target.files[0]);
    e.target.value = "";
  });
  $("q").addEventListener("input", (e)=>{ state.q = e.target.value; render(); });
  $("filterType").addEventListener("change", (e)=>{ state.filterType = e.target.value; render(); });

  render();
</script>
</body>
</html>
