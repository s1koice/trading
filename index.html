<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trading Journal</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background:#0b0f19; color:#e7eaf3; }
    header { padding: 20px 16px; border-bottom: 1px solid #1b2440; position: sticky; top:0; background:#0b0f19; z-index: 5; }
    h1 { margin: 0 0 6px; font-size: 18px; }
    .sub { color:#aab3d3; font-size: 13px; }

    main { max-width: 1150px; margin: 0 auto; padding: 16px; display: grid; gap: 16px; grid-template-columns: 380px 1fr; }
    .card { background:#0f1629; border:1px solid #1b2440; border-radius: 16px; padding: 14px; }
    .card h2 { margin: 0 0 10px; font-size: 14px; color:#cfd6f5; }
    .muted { color:#aab3d3; font-size: 12px; }
    .ok { color:#6ee7b7; }
    .warn { color:#fbbf24; }
    .bad { color:#fb7185; }

    label { display:block; font-size: 12px; color:#aab3d3; margin: 10px 0 6px; }
    input, select, textarea, button {
      width: 100%; box-sizing: border-box; border-radius: 12px; border: 1px solid #223057;
      background:#0b1020; color:#e7eaf3; padding: 10px 12px; font-size: 14px;
    }
    input:disabled, select:disabled, textarea:disabled { opacity: 0.6; cursor: not-allowed; }
    textarea { min-height: 88px; resize: vertical; }
    button { cursor:pointer; border: 1px solid #2d3d6f; background:#111a33; }
    button:hover { filter: brightness(1.05); }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .btnRow { display:flex; gap: 10px; }
    .btnRow button { width: auto; flex: 1; }

    .kpi { display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .kpi .box { background:#0b1020; border:1px solid #223057; border-radius: 14px; padding: 10px; }
    .kpi .v { font-size: 18px; margin-top: 4px; }

    .divider { border:none; border-top:1px solid #1b2440; margin:14px 0; }

    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 14px; border:1px solid #1b2440; }
    th, td { padding: 10px; border-bottom:1px solid #1b2440; vertical-align: top; font-size: 13px; }
    th { text-align:left; color:#cfd6f5; background:#0b1020; position: sticky; top: 74px; z-index: 3; }
    tr:hover td { background:#0b1020; }
    .right { text-align:right; }
    .tag { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid #223057; font-size: 12px; color:#cfd6f5; }
    .pill { display:inline-flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .actions { display:flex; gap:8px; }
    .actions button { padding: 8px 10px; }

    .toast {
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: #0b1020; border:1px solid #223057; border-radius: 14px; padding: 10px 12px;
      min-width: 260px; max-width: 92vw; display:none; z-index: 10;
    }

    @media (max-width: 980px){
      main { grid-template-columns: 1fr; }
      th { top: 0; position: static; }
    }
  </style>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<header>
  <h1>Trading Journal</h1>
  <div class="sub">–ñ—É—Ä–Ω–∞–ª —Å–¥–µ–ª–æ–∫ + –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (Supabase Postgres)</div>
</header>

<main>
  <section class="card">
    <h2>üîê –ê–∫–∫–∞—É–Ω—Ç</h2>

    <label>Email</label>
    <input id="email" placeholder="you@email.com" autocomplete="email" />

    <label>–ü–∞—Ä–æ–ª—å</label>
    <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />

    <div class="btnRow" style="margin-top:10px;">
      <button id="loginBtn" type="button">–í–æ–π—Ç–∏</button>
      <button id="signupBtn" type="button">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>

    <div class="btnRow" style="margin-top:10px;">
      <button id="logoutBtn" type="button">–í—ã–π—Ç–∏</button>
      <button id="reloadBtn" type="button">–û–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å–∏</button>
    </div>

    <div class="muted" id="authState" style="margin-top:10px;">–ü—Ä–æ–≤–µ—Ä—è—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é‚Ä¶</div>

    <hr class="divider">

    <h2>‚ûï –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h2>

    <div class="row">
      <div>
        <label>–î–∞—Ç–∞</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>–¢–∏–ø</label>
        <select id="type">
          <option value="trade">–°–¥–µ–ª–∫–∞</option>
          <option value="market">–ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞</option>
          <option value="review">–†–∞–∑–±–æ—Ä –¥–Ω—è</option>
        </select>
      </div>
    </div>

    <label>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä BTCUSDT / ES / AAPL)</label>
    <input id="symbol" placeholder="BTCUSDT" />

    <div class="row3">
      <div>
        <label>–°–µ—Ç–∞–ø / —Å—Ç—Ä–∞—Ç–µ–≥–∏—è</label>
        <input id="setup" placeholder="Breakout / Pullback / Range..." />
      </div>
      <div>
        <label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
        <select id="side">
          <option value="">‚Äî</option>
          <option value="long">Long</option>
          <option value="short">Short</option>
        </select>
      </div>
      <div>
        <label>–†–∏—Å–∫ (R)</label>
        <input id="risk" type="number" step="0.1" placeholder="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>–†–µ–∑—É–ª—å—Ç–∞—Ç (R)</label>
        <input id="resultR" type="number" step="0.1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 1.5 –∏–ª–∏ -1" />
      </div>
      <div>
        <label>–≠–º–æ—Ü–∏—è</label>
        <select id="emotion">
          <option value="">‚Äî</option>
          <option>—Å–ø–æ–∫–æ–π–Ω–æ</option>
          <option>—Å—Ç—Ä–∞—Ö</option>
          <option>–∂–∞–¥–Ω–æ—Å—Ç—å</option>
          <option>—Ñ–æ–º–æ</option>
          <option>–∑–ª–æ—Å—Ç—å</option>
          <option>—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</option>
        </select>
      </div>
    </div>

    <label>–ü–ª–∞–Ω / –∫–æ–Ω—Ç–µ–∫—Å—Ç (—á—Ç–æ –≤–∏–¥–µ–ª –Ω–∞ —Ä—ã–Ω–∫–µ)</label>
    <textarea id="context" placeholder="–¢—Ä–µ–Ω–¥, —É—Ä–æ–≤–Ω–∏, –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å, –Ω–æ–≤–æ—Å—Ç–∏, —á—Ç–æ –æ–∂–∏–¥–∞–ª..."></textarea>

    <label>–ò—Ç–æ–≥ / –æ—à–∏–±–∫–∏ / —á—Ç–æ —É–ª—É—á—à–∏—Ç—å</label>
    <textarea id="lessons" placeholder="–ß—Ç–æ —Å–¥–µ–ª–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –≥–¥–µ –Ω–∞—Ä—É—à–∏–ª –ø—Ä–∞–≤–∏–ª–∞, –ø–ª–∞–Ω —É–ª—É—á—à–µ–Ω–∏—è..."></textarea>

    <div class="btnRow" style="margin-top:10px;">
      <button id="saveBtn" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î</button>
      <button id="resetBtn" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <p class="muted" style="margin-top:10px;">
      ‚ö†Ô∏è –ï—Å–ª–∏ —Ç—ã –Ω–µ –≤–æ—à—ë–ª ‚Äî –∑–∞–ø–∏—Å—å –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è. –°–Ω–∞—á–∞–ª–∞ <b>–í–æ–π—Ç–∏</b> / <b>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</b>.
    </p>
  </section>

  <section class="card">
    <h2>üìä –î–∞—à–±–æ—Ä–¥</h2>
    <div class="kpi" id="kpi"></div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label>–ü–æ–∏—Å–∫</label>
        <input id="q" placeholder="BTC / breakout / –æ—à–∏–±–∫–∏..." />
      </div>
      <div>
        <label>–§–∏–ª—å—Ç—Ä —Ç–∏–ø–∞</label>
        <select id="filterType">
          <option value="">–í—Å–µ</option>
          <option value="trade">–°–¥–µ–ª–∫–∞</option>
          <option value="market">–ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞</option>
          <option value="review">–†–∞–∑–±–æ—Ä –¥–Ω—è</option>
        </select>
      </div>
    </div>

    <div class="muted" id="listState" style="margin-top:10px;">‚Äî</div>

    <div style="margin-top:12px; overflow:auto;">
      <table>
        <thead>
          <tr>
            <th style="width:110px;">–î–∞—Ç–∞</th>
            <th style="width:110px;">–¢–∏–ø</th>
            <th>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</th>
            <th style="width:100px;" class="right">R</th>
            <th style="width:140px;">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </section>
</main>

<div class="toast" id="toast"></div>

<script>
  // =========================
  // 1) SUPABASE CONFIG
  // =========================
  const SUPABASE_URL = "https://lchstbkuizgablzdczgf.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjaHN0Ymt1aXpnYWJsemRjemdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NzE2MDQsImV4cCI6MjA4MjM0NzYwNH0.0HnmhHZSDNktliI1ieg7F_ehVuvDp3nwh8vhFJM6eRg";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // =========================
  // 2) HELPERS
  // =========================
  const $ = (id) => document.getElementById(id);

  function toast(msg, kind = "ok") {
    const t = $("toast");
    t.style.display = "block";
    t.innerHTML = `<span class="${kind}">${escapeHtml(msg)}</span>`;
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => (t.style.display = "none"), 2600);
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function todayISO(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60*1000);
    return local.toISOString().slice(0,10);
  }

  function numOrNull(v){
    if (v === "" || v == null) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function formatType(t){
    return t === "trade" ? "–°–¥–µ–ª–∫–∞" : t === "market" ? "–ê–Ω–∞–ª–∏–∑" : "–†–∞–∑–±–æ—Ä";
  }

  function setFormEnabled(enabled){
    const ids = ["date","type","symbol","setup","side","risk","resultR","emotion","context","lessons","saveBtn","resetBtn"];
    ids.forEach(id => $(id).disabled = !enabled);
  }

  // =========================
  // 3) STATE
  // =========================
  const state = {
    entries: [],
    filterType: "",
    q: ""
  };

  let currentUser = null;

  // =========================
  // 4) AUTH
  // =========================
  async function refreshAuth(){
    const { data, error } = await supabase.auth.getUser();
    if (error) {
      currentUser = null;
      $("authState").innerHTML = `<span class="bad">–û—à–∏–±–∫–∞ auth:</span> ${escapeHtml(error.message)}`;
      setFormEnabled(false);
      return;
    }

    currentUser = data.user || null;

    if (currentUser) {
      $("authState").innerHTML = `‚úÖ <span class="ok">–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω:</span> ${escapeHtml(currentUser.email)}`;
      setFormEnabled(true);
      $("logoutBtn").disabled = false;
    } else {
      $("authState").innerHTML = `‚ö†Ô∏è <span class="warn">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.</span> –í–æ–π–¥–∏ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è.`;
      setFormEnabled(false);
      $("logoutBtn").disabled = true;
    }
  }

  async function login(){
    const email = $("email").value.trim();
    const password = $("password").value;
    if(!email || !password) { toast("–ó–∞–ø–æ–ª–Ω–∏ email –∏ –ø–∞—Ä–æ–ª—å", "warn"); return; }

    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) { toast(error.message, "bad"); return; }

    await refreshAuth();
    await loadFromDB();
    toast("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω", "ok");
  }

  async function signup(){
    const email = $("email").value.trim();
    const password = $("password").value;
    if(!email || !password) { toast("–ó–∞–ø–æ–ª–Ω–∏ email –∏ –ø–∞—Ä–æ–ª—å", "warn"); return; }

    const { error } = await supabase.auth.signUp({ email, password });
    if (error) { toast(error.message, "bad"); return; }

    // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ email confirmation, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω —Å—Ä–∞–∑—É
    await refreshAuth();
    await loadFromDB();
    toast("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞. –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email ‚Äî –ø—Ä–æ–≤–µ—Ä—å –ø–æ—á—Ç—É.", "ok");
  }

  async function logout(){
    await supabase.auth.signOut();
    await refreshAuth();
    state.entries = [];
    render();
    toast("–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω", "ok");
  }

  // =========================
  // 5) DB (entries)
  // =========================
  function mapFromDB(x){
    return {
      id: x.id,
      date: x.date,
      type: x.type,
      symbol: x.symbol || "",
      setup: x.setup || "",
      side: x.side || "",
      risk: x.risk,
      resultR: x.result_r,
      emotion: x.emotion || "",
      context: x.context || "",
      lessons: x.lessons || "",
      createdAt: x.created_at
    };
  }

  async function loadFromDB(){
    if(!currentUser){
      $("listState").textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö: –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏.";
      state.entries = [];
      render();
      return;
    }

    $("listState").textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

    const { data, error } = await supabase
      .from("entries")
      .select("*")
      .order("date", { ascending: false })
      .order("created_at", { ascending: false });

    if (error){
      $("listState").innerHTML = `<span class="bad">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:</span> ${escapeHtml(error.message)}`;
      state.entries = [];
      render();
      return;
    }

    state.entries = (data || []).map(mapFromDB);
    $("listState").textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${state.entries.length}`;
    render();
  }

  async function insertToDB(entry){
    if(!currentUser){
      toast("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –ë–î", "warn");
      return false;
    }

    const payload = {
      user_id: currentUser.id,
      date: entry.date,
      type: entry.type,
      symbol: entry.symbol || null,
      setup: entry.setup || null,
      side: entry.side || null,
      risk: entry.risk,
      result_r: entry.resultR,
      emotion: entry.emotion || null,
      context: entry.context || null,
      lessons: entry.lessons || null
    };

    const { error } = await supabase.from("entries").insert(payload);
    if (error){
      toast("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + error.message, "bad");
      return false;
    }

    return true;
  }

  async function deleteFromDB(id){
    if(!currentUser) return;
    const { error } = await supabase.from("entries").delete().eq("id", id);
    if (error) toast("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + error.message, "bad");
  }

  // =========================
  // 6) UI LOGIC
  // =========================
  function resetForm(){
    $("date").value = todayISO();
    $("type").value = "trade";
    $("symbol").value = "";
    $("setup").value = "";
    $("side").value = "";
    $("risk").value = "";
    $("resultR").value = "";
    $("emotion").value = "";
    $("context").value = "";
    $("lessons").value = "";
  }

  function filtered(){
    const q = state.q.trim().toLowerCase();
    return state.entries.filter(e => {
      const okType = !state.filterType || e.type === state.filterType;
      const hay = [
        e.symbol, e.setup, e.side, e.emotion, e.context, e.lessons, e.type, e.date
      ].join(" ").toLowerCase();
      const okQ = !q || hay.includes(q);
      return okType && okQ;
    });
  }

  function render(){
    // KPI
    const trades = state.entries.filter(e => e.type === "trade");
    const totalR = trades.reduce((s,e)=> s + (Number(e.resultR) || 0), 0);
    const wins = trades.filter(e => (Number(e.resultR) || 0) > 0).length;
    const losses = trades.filter(e => (Number(e.resultR) || 0) < 0).length;
    const winrate = trades.length ? Math.round((wins / trades.length) * 100) : 0;

    const kpi = [
      {k:"–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π", v: state.entries.length},
      {k:"–°–¥–µ–ª–æ–∫", v: trades.length},
      {k:"Winrate", v: winrate + "%"},
      {k:"–°—É–º–º–∞—Ä–Ω–æ R", v: (Math.round(totalR*10)/10).toString()}
    ];

    $("kpi").innerHTML = kpi.map(x =>
